require "../src/mitm.cr"
require "http/server"

OpenSSL::X509::SuperRequest.new

# dsa = OpenSSL::PKey::DSA.new bits: 4096_i32
# STDOUT.puts [dsa.private_key?.try &.to_s, dsa.public_key?.try &.to_s]

rsa = OpenSSL::PKey::RSA.new bits: 4096_i32
STDOUT.puts [rsa.private_key?.try &.to_s, rsa.public_key?.try &.to_s]

certificate = Base64.decode_string "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZCRENDQXV3Q0NRQ1FnSFNNN3F2NmN6QU5CZ2txaGtpRzl3MEJBUXNGQURCRU1Rc3dDUVlEVlFRR0V3SkcKU1RFUU1BNEdBMVVFQ0F3SFJtbHViR0Z1WkRFUk1BOEdBMVVFQnd3SVNHVnNjMmx1YTJreEVEQU9CZ05WQkFNTQpCMFpwYm14aGJtUXdIaGNOTWpJd016RXpNakV3TURFeVdoY05Nekl3TXpFd01qRXdNREV5V2pCRU1Rc3dDUVlEClZRUUdFd0pHU1RFUU1BNEdBMVVFQ0F3SFJtbHViR0Z1WkRFUk1BOEdBMVVFQnd3SVNHVnNjMmx1YTJreEVEQU8KQmdOVkJBTU1CMFpwYm14aGJtUXdnZ0lpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElDRHdBd2dnSUtBb0lDQVFDWApvaldod1pwRjhLbElLYWQ1TE9nU09kaWE4YWpjN0lBNWNoOXkrYjM5OEcxNTRVMm1PSHh6ejE2WmxVaUtDSXFrCnQxSW02bkNJWUlDYnpjT1gvSjRTTlI1bnVlMG8wZ1RwSTNDUFJpSmsydkdpMzhPeC96VEFrbDFqWCtrcEpDb2UKSDFHckNub1VFTTV2SVcrNDJyRkk3bHkvZmxkOEVUd1NyUEYybWNiQTJ2ME9NQ1ZlL2Q4UHMyK1RFSDNTcW9RQQp4dE9NcDU1blRPWVBVUGxKc25iUEJzNUl2R0hOeWREbjRXN3ZsejlvMzJXMTlmNkVoWk5leEh0ZWkrQVRibzBCCmdRU2NuRW5WTWZXdm1mL3hlaFpNRFdtL2NPZmN5aHB4Vi9KZHl6bVdSbDErdXNLeXB2Sk1tZXJ4WjRxMmhhSVEKdmhjUDdMZ3FaWUFNM1dZc0ZDb2J6S2EybHdicEdwb24zeWJTZmZDcWJ6TmVNRWFXVWJ1U1VENVlHVUFrOXh4cwplYW5oNms1aGh0K0JVRmU3TTl1UkQ0bnFwSDlaZVN0STdQeGQzcTVDSDFubUVneUdqOWp6MnU0RXk5cVRuNmltCm9rN29sKzBERFM1SzNtYyswUEplYnJJeVhmcUk5TGZDbW5kekVZZG9laFVzclFtbjJEV1pQY1lUOStMVGlHZ2cKZVUyUGJ2VHBQdGQrT3A2U1ZYRHJRSDl4SjdvUG15NlBtYUEzNGtPdTNZZjlmYlBSR2d1WmFwQTRGZnh2TUJxSgpIK29MUGU3TUFRSTZFcW1DYWpCd3BpTjVvdXErUHlMRWFsOC8wZ3BEVTJGT1ZlU2VPVnFoekg2QTBjYldzVmVuClZlRXIveEQvRjZNb2JCZEYyVW1FSks3VTU0VkV0T0p3K2FwTmh3SDNTd0lEQVFBQk1BMEdDU3FHU0liM0RRRUIKQ3dVQUE0SUNBUUJqZXg3ZitiTlYxc2MzRkNMbjI2dm9BMlhIOW1zWVlJZzNYSDBVVHNGeEtzd1EyQUZXejVZRwpBd1NXYUV6a2laYTZhWU02TGRINFhsWjJldyt5ZHNUdGVwRU9TNjVGNWdBOGtMUHVQSGZVVHlLVmJyRlNXUHpmCjNhNi9LeHEvakZ6QUd5YUZlSHdkK21PTHJueEFGdGZmaTlQY1lGU2ppNHVhYXBzWlc3Q29ublFFbGlheCt2bUwKSlFqN2VXTm1qNkk3OUxKZG1tbDFlVGIyZmxobUQ1aGIzTThQRnV2clhlYzRHNEdFYVJzZFNVYWo2VnkzUEJ6TQpzTThvbWNWTy9mYkZ5SGhkaWRqVGFuQlFTbXh4ZFU0M20wYUNmRXlkN0RhL1dMbkRrS0xrNXcxWXF3VlV0OTVlClRnSWtBVktwWndwcnFPZXpSWmFibXE5M0I0QzdSM2RMYlByV1FhWC9sS2I4dkNua1c3U2dQL0IrdmM5NUFnVWkKRGFIS1ZFcEE1ZGNlajBHem94SjJkZ2VmQm5JQmxKck1CUjJsT2dsbXo5VnJSZ1VDSWUwVmgwVTViWkJUL0FpYwowZGp3L3lBRlpmYmJCSlVOaEFyWDZCK2RvR2VIL0hSVDA3YTNnQmhrMEt0b0xyNE5ZbTFWKytPMVZVYmxOenl1CnNHYVZPMHpTQ291TU1hcWhFK3BPVERqTG9pRGVUWmc1VlRTUi9OaHc0aERwNm0wK2wrQzU4WENpKzZ3OWQ2SkEKTWtSWDJHeXRlNXRoTDhxa05yRUMrUEtpL1pkRk42OVArekh3cG9ZWWh2Lzd2Q0puc2cvNkpJYkV5Q0VtamQrdwpmVkdRWnZDUDZtcVNDaTA0NmJsaFFzaWJpbUtrakpWa2I0QmVKMEljdW5HeFk0ZS9LSGtQQlE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="
private_key = Base64.decode_string "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS2dJQkFBS0NBZ0VBbDZJMW9jR2FSZkNwU0NtbmVTem9Fam5ZbXZHbzNPeUFPWElmY3ZtOS9mQnRlZUZOCnBqaDhjODllbVpWSWlnaUtwTGRTSnVwd2lHQ0FtODNEbC95ZUVqVWVaN250S05JRTZTTndqMFlpWk5yeG90L0QKc2Y4MHdKSmRZMS9wS1NRcUhoOVJxd3A2RkJET2J5RnZ1TnF4U081Y3YzNVhmQkU4RXF6eGRwbkd3TnI5RGpBbApYdjNmRDdOdmt4QjkwcXFFQU1iVGpLZWVaMHptRDFENVNiSjJ6d2JPU0x4aHpjblE1K0Z1NzVjL2FOOWx0ZlgrCmhJV1RYc1I3WG92Z0UyNk5BWUVFbkp4SjFUSDFyNW4vOFhvV1RBMXB2M0RuM01vYWNWZnlYY3M1bGtaZGZyckMKc3FieVRKbnE4V2VLdG9XaUVMNFhEK3k0S21XQUROMW1MQlFxRzh5bXRwY0c2UnFhSjk4bTBuM3dxbTh6WGpCRwpsbEc3a2xBK1dCbEFKUGNjYkhtcDRlcE9ZWWJmZ1ZCWHV6UGJrUStKNnFSL1dYa3JTT3o4WGQ2dVFoOVo1aElNCmhvL1k4OXJ1Qk12YWs1K29wcUpPNkpmdEF3MHVTdDVuUHREeVhtNnlNbDM2aVBTM3dwcDNjeEdIYUhvVkxLMEoKcDlnMW1UM0dFL2ZpMDRob0lIbE5qMjcwNlQ3WGZqcWVrbFZ3NjBCL2NTZTZENXN1ajVtZ04rSkRydDJIL1gyegowUm9MbVdxUU9CWDhiekFhaVIvcUN6M3V6QUVDT2hLcGdtb3djS1lqZWFMcXZqOGl4R3BmUDlJS1ExTmhUbFhrCm5qbGFvY3grZ05IRzFyRlhwMVhoSy84US94ZWpLR3dYUmRsSmhDU3UxT2VGUkxUaWNQbXFUWWNCOTBzQ0F3RUEKQVFLQ0FnRUFna2N3a3hpV3BxNmRrczJQQVJKdkZYR3p3M1FMWkR5aDhqazJBZi9HbDg0aEVRMWRQSW5kaTFiSQpiV1lRVzkvNDFvcFd2KzYrM3IwaTRqb0lhYVgyWGFoYnhqeTlJVXhJUWRKY0hBemk4Z29XZjV5SE00QVQzN3doCkZvZEorVG9FSWJ0QTNKWjB5cGFoOW1NZzdRNmdNUXZ5amVoTDIrR20zbGpPWU5yQUkrUkNkUlV5bG9uQ1EyZ2sKWFpOV3QxQWZkOWRiM01ZSzE2Ly9IWHV4b3ZyOUR1UkhDY0VvdXJsQmptaG1ldDFVOHBLMWZYK3J2RXBUa3FGMwphWVQ5OFZRVFBBNlFXc29BdVhaaUl3eEtGVHVTdXFidml6YkRUelFwUWVhUTZycjNjRUJtaGNLS0V4cFNwVE84CjRzbldLUGxwZzc3K2E0VXp1ZUZaQWpTYVd4YThFYkhRQ05wZlZVRmV6Q2xTMGlhODlRc24xMnQzS0graUkvaUUKT0xsYlFqb2dSWEJEUlN0SlkwR3NadFBLbElVdUdMM0pLQTZFN01MNnhvZWR3M2ZhNVNHS2QvRVZxb1VnMDBkdwpmR3NxNVY0VDJiK0REV3p3aHFXVGoydkFZbVo3TjN1b3JyTlk5ZXFqWnhGV2EyVUJ6L1h3ZWllNUdWSVIrS0N6CmhzbG9ETUlBTVJzTGs4bXYyK2syQ2l1K2kvK1NoaXg5Z2d4TWRxak9hREpiTkVHaUZncC9pamVmLzJkMnhEaUEKVmZvLy81bFBPR2V3VjRrbXVrOTdlUWl4OXVUaFg4MFZCalFmQUZRZVRaejZuM2pJRjVVV0VoRzNDYXJQQnBPNwpJbnRkU3c2dCtlU1I4NEV3bjJlY1V2dCtadElyZWFGbUdxemF1ZVRwOTdoSWJ6VGlYVEVDZ2dFQkFNZFVucWhXCmx6LzZjVWwzeVUzM0NNbUlKVUFHMFl3dExxZng0ZmRhNktvempwNG1iL3BtVXJlMlJlTTkydXk1TnFKL25MZFQKcEIvWmRNVysvQjV5OEx2Nk1FMlllRlRsZXhRSU00YVhEZVdVOFRnRWtaMEFzcUF1MDA0UzJnTGhsVWNWK3lBcApDcGsxMmlyNWU5bjdQNHd5eGlKbkNkaGJNanB4aWFNV01JeW1PODBVUlB3NXJWaDNBQjJ1MU8xWEJYYjR0dEhSClVMWnVlS2l6ZStqVnhPTTFMelV1MEtYc3hGakMveGdlaXNnZk5sbFVLcURWeUw4L2pMenF3TmJmRzNmRlNJd0sKclY4N25vbTdORnFMcS82MGVTczhNRjR0S0dnUk1pMHBiOXhBcHlmK3dpVDlrUERtcnJpTDJ2eVg1UGhLT2tkVwpyMDBGSmxLbTlPRHJ0Zk1DZ2dFQkFNSytMdi9lZ0JJUVR6elJYbklKQzRvTW9oa0QxUTIrSVI3eXFycHdtTTFGCit5T2FxWDlYY3dPT2VLNHJOZUtVdGpocll2bER0NXE2VGhrTFZEams3eldBWDl6ODhZcnpKSUJ5Ti95YjlEaDkKMVgwMzZKVDlucnJRbjlwK1BUWEY1NjQybUdISE5uWDY5SlcvcU1yYWNSVllsaVI4M2d1V0dnVDYyN3lZeDBxawozaTNrT3lTNE11RWJsWVlpZ0xTcW5TM3lSTGZwU1hKeEhMNVgwd3RGMTdLK3hkM3dmWFpRek1DMUtqWitXM0ltCkJvRUZRdHlDMm0ybUdzRkFkTVdtbk9zWUY2dFFLWmZxVGZDa3R6TTFQc3FVeVJlVFpTL0tHcUthQ3poOGdxY08KYkdOYUhqaGFCRCtnQWMxQTJuUVQwcGNrUFNMWjZTR1lJdXRhL0swVTEwa0NnZ0VBT3dYMWpRZEc5aXpraXNxcgpreWlKTTVQYTQrQ2hBQThJOTdZS0lVS01Eb29CdXhiS3BhelM1WTlWbG5wa2J5QlE2MEU2V0phdHpMaUplVnlhCkx6SDkwc3U4cmQxdUZFVjNjbkVUUU5GTnppT1NZZklJWkNNbXdZUGNFZ3hHL2Y5cVFvaGh1aDR0QXowTkF4aW8KOGQwUjdpUEN3OEViQ3pQRjVjUms2eVBROEhUdzFFTWlRa1daN000Zi9Lb2Vac0VUM3l5NmhkcWpPY0h3ZkpQWgpKeExWb0NuSmRzZ01CSFhkbGlMM2dsN1kzWFZRbEpiMW9IWnRZU1FpT25hUTc0OVZCTndvSlQrc0lyejJydlgrCkJLbkRIa0syZG5UMkpZemRvQ01uWm5RVXFYV0RpYlpJS3NmaXVWSzFmZlA3dmp3RUV2bDMxRlA0eUtlenQxbTAKdlQxT3ZRS0NBUUVBbU9Da0ZNbWUwSTl0Sk5sWHd6M0dpVUVSbjRHYXA0Y3lpUkVIWmdVdWJ6Y1l5QUtLUFNWeApiTUZUaTZid1RrZGdKVHBvSURaQTFINmRBSndjS2UzT3U3bGppQ0Fwbm1MeHJNUDluNWp1UjhyQTVlUVYrYUNBCkV6Zmp4YXFFY3NwQjdrbDlwb1MxQkRsVitKalU4U282eS84WEh0M0hrbURyWEMxeWdzT003OVF0ZHVsTVpLOFYKZ2hJZGQ0ZHVjbVhkcmt3YUZpWlZPam9Cem9zemFnNFNIb2dVM1A0Ri8vTytTU252VVlnd1VaUDRWeURDTkVtbApINTdlTWdkZnBDbi8xYTY4Smdod0hvb1pWV2g1U1FIcm9TemNFRjN0ZVc2M0toNno0RXdlWlBhMXIrajNBRlhxCkwraDBnYVQvMlZBV2FnQlEzaU1qR1BSTnRXVmdKcC9Od1FLQ0FRRUFtRzRVQ1NQdDFFUTR6QXBLOGQ2cnlYNlMKVjZ3Q25Xck1EUU5VNk1EMlFSSmhZSFJUenY2Zk1WR0g4Vjg4R1lRMytmYWdsU3JZNmdTTml5Z1VDYURmbUdHRwpHbmJWMmJKWmhnSVJGS1VCblNUM1NGVFdhWGY5STVsR3VSdWpMMGZJc2lCamVnQVdNWGdCQkdnMzdrbWdWWWpqCmd5K24xZXh3cm1LTzV2MkF0cUt6MnpPUFBHeHZPYVNycmRvR3BoMjgvcW1LRHFQTEl6Q3BBRndFaFJteENtVVIKelozbkplai9hR1BmZnpkOEI0Y1UwVE9qWWd5b2R2K2pYUklCbEcyVEhhWHExT3BxZCtqem1xN3V5QWUxYXF0dQpXa3lHV0tmdWpDVGtZRGFZVy9VYUljSlRWR0hEK0EvbVZ6emx6Y0JxekJ4ajVUNTRHejRBRUloTGdYVk9Ndz09Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg=="

caching = Mitm::Caching.new capacity: 1024_i32
mitm_context = Mitm::Context.new rootCertificate: certificate, rootPrivateKey: private_key, caching: caching
context_server = mitm_context.create_context_server hostname: "www.google.com"

server = HTTP::Server.new { |context| STDOUT.puts [context] }
address = server.bind_tls host: "0.0.0.0", port: 1234_i32, context: context_server

puts "Listening on http://#{address}"
server.listen
